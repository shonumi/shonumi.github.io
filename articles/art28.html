<!DOCTYPE HTML>
<html>
	<head>
		<title>Edge of Emulation: Advance Movie Adapter</title>
		<link rel="stylesheet" type="text/css" href="./../main.css" />

		<meta property="og:title" content="Edge of Emulation: Advance Movie Adapter" />
		<meta property="og:image" content="https://shonumi.github.io/articles/am3_mini.png" />
		<meta property="og:description" content="Emulating the unknown: Portable videos on the Game Boy Advance" />
		<meta property="og:type" content="article" />
 		<meta charset="utf-8" />

	</head>

	<body>

		<!-- Main Header -->
		<div class="header">

			<!-- Left Header -->
			<div class="header_left">
				<div class="header_text"><strong>Shonumi</strong></div>
			</div>
		
			<!-- Right Header -->
			<div class="header_right">
				<a class="header_link" href="../downloads.html">Downloads</a>
				<a class="header_link_current" href="../articles.html">Articles</a>
				<a class="header_link" href="../blog.html">Blog</a>
				<a class="header_link" href="../index.html">Main</a>
			</div>

		</div>

		<!-- Main Page Outer Box -->
		<div class="box_outer">
			
			<!-- Main Page Inner Box -->
			<div class="box_inner">

				<div class="center_headline">Edge of Emulation: Advance Movie Adapter</div>
				<div class="headline_underline">. . . . . . . . . . .</div>

				<p class="center_img"><img src="am3_01.png" alt="" /></p> 

				<p class="inner_text_large"><strong>The Multimedia Revolution</strong></p>

				<p class="inner_text">Before the rise of modern smartphones, the portable multimedia landscape was somewhat fractured. While today&#39;s mobile devices consolidate all manner of audio and video into a single package, the tech industry was slow to bring these elements together. Apple&#39;s iconic iPod and a plethora of MP3 players popularized portable digital music, yet consumers had fewer options regarding decent, reasonably priced video players. For some of the earliest dedicated video players available, often the supported formats were limited, disk space cost a premium, and battery life was not particularly efficient. At this time, there was demand for both music and video on-the-go, but initially the former was better served by companies and products.</p>

				<p class="inner_text">It was in this environment that companies turned to several solutions, one of those being video game consoles. Nintendo released the Play-Yan late in the Game Boy Advance&#39;s lifetime, a special cartridge capable of audiovisual playback using files from an SD card. Earlier, Sony&#39;s Playstation Portable let gamers view their own videos or buy Universal Media Discs with films burned to the medium. Prior to all that, Majesco Entertainment started releasing GBA cartridges with cartoon shows and select movies crammed onto ROM chips. One of the earliest attempts at bringing video to handheld consoles is, however, perhaps the most obscure and forgotten.</p>

				<p class="inner_text">On November 20, 2003, a company called AM3 released a new peripheral for the GBA called the Advance Movie Adapter. It was an oversized cartridge that featured a side-slot for accepting SmartMedia cards. Through the adapter, the Game Boy could read the data stored on the card. Each SmartMedia card contained video, typically 1 or 2 episodes of an anime or a full-length feature film in some cases. Audio and video were compressed to better work with the GBA&#39;s hardware. Once given Nintendo&#39;s approval and the backing of franchises such as <em>Pokemon</em> and <em>Detective Conan</em>, AM3 launched the Advance Movie Adapter exclusively in Japan. These efforts enjoyed a fair amount of success across the country, being supported well into 2007 before AM3 completely pivoted to the Nintendo DS.</p>

				<p class="inner_text">Throughout the early 2000s, handheld gaming systems proved very attractive as relatively low-priced, energy efficient, and user-friendly devices with the added benefit of some amount of copy-protection. The hardware was already designed around audio and video output, making it a natural choice during this era. Unfortunately, emulating this aspect of both GBA and PSP currently requires more work. UMD movie support still needs to be added or improved in PSP emulators. The Play-Yan remains an elusive target for GBA emulators as well. Thankfully, however, Majesco&#39;s GBA Video Cartridges have been working in mGBA and VBA-M for years. Even though TV shows on handheld consoles don&#39;t actually count as a video games, they need to be preserved as a matter of history. They&#39;re integral to understanding the evolution of mobile media as we know it today. There is much to do in this area of emulation, and AM3&#39;s Advance Movie Adapter serves as a perfect starting point.</p> 

				<p class="inner_text_large"><strong>Terra Firmware</strong></p>

				<p class="inner_text">I have investigated a lot of challenging hardware over the years, as detailed in various <strong>Edge of Emulation</strong> articles. Having focused primarily on the Game Boy, I&#39;ve already documented most of its strange and exotic accessories. In each case, I&#39;ve gone after ones I felt the most comfortable researching at the time, using the experience I gained from one to help me with the next. I feel quite at home reverse-engineering devices that use infrared, Link Cables, or specialty cartridges with existing dumps that can be debugged. However, as the list of undocumented Game Boy hardware dwindles, I&#39;m left with a handful of products that force me to learn new tricks. The Advance Movie Adapter falls into this category, becoming one of the most difficult and complex products I&#39;ve ever had to pick apart.</p>

				<p class="inner_text">The immediate problem with the adapter is its cartridge design. It has large half-black, half-white plastic shell that extends past the GBA&#39;s slot. On the right side it features a built-in SmartMedia card reader. This isn&#39;t standard Game Boy stuff at all. Aside from the Play-Yan and the Jukebox, the Advance Movie Adapter is the only officially licensed GBA cartridge that lets users insert some kind of flash memory card. Fully supporting the adapter in GBE+ meant providing the emulator with whatever information was stored on the SmartMedia card. That, in turn, meant I&#39;d have to dump the SmartMedia card. At this point, it was unknown if just the files on the SmartMedia card would suffice or if an entire disk image of the card was necessary. On top of that, there was an unidentified encryption scheme on the SmartMedia card. All I knew when I started was that it used 128-bit DES as some sort of anti-piracy measure.</p>

				<p class="inner_text">On top of all of these issues, little to nothing was known about how the adapter booted up. The adapter has to run code - firmware in this case - on the GBA just like any other cartridge, but no one had made a complete dump of it. Normally people can use something like a Sanni cart reader, GBxCartRW, or even an NDS running homebrew to dump almost any GBA cartridge. Unfortunately, the Advance Movie Adapter is anything but normal. On two separate occassions, associates contacted me via Discord and shared what they&#39;d managed to pull from the adapter. It was always incomplete, repeating the same values every few kilobytes, indicating to me that the cartridge must have had some special control mechanisms to swap data in/out or perform some kind of ROM banking technique. The dumps wouldn&#39;t even boot up in any emulator, appearing to rely on some unimplemeneted hardware behavior specific to the adapter.</p>

				<p class="inner_text">In short everything about the Advance Movie Adapter was a total mystery. No one knew what AM3 SmartMedia card data looked like, and no one knew what the adapter&#39;s boot sequence looked like. The only way to go any further was to probe the hardware directly. As the adapter had a good run in Japan, it&#39;s not hard to find. I stumbled upon brand new sets of Detective Conan Episodes #1 and #2 for a fair price last year. The effects of the pandemic were still inflating shipping costs from Japan, however, by now it was just part of doing business. The Advance Movie Adapter was sold in small plastic packages, typically as a bundle that included at least 1 SmartMedia card. Additionally, some individual episodes were sold without the adapter.</p>

				<p class="center_img"><img src="am3_02.png" alt="Advance Movie Adapter" /> <img src="am3_03.png" alt="Card" /></p>
				<p class="img_caption">The Advance Movie Adapter along with an AM3 SmartMedia card.</p>

				<p class="inner_text">Once the adapter arrived in my possession, I tried dumping anything on the cartridge using a DS. As expected, the results were the same as my colleagues: a 1KB blob of code that kept repeating. This code was likely used to setup the GBA before reading from the SmartMedia card and playing video. How it did so was not clear, but if I looked at the instructions and mapped out its programming, I could begin to piece things together. Running the 1KB dump through GBE+&#39;s debugger, the first thing I did was look for any unusual reads or writes. It&#39;s common for unique cartridges like the Advance Movie Adapter to access non-standard features and hardware by writing to areas of memory that most GBA software ordinarily never touch. Looking for any such memory addresses is a good way to begin reverse-engineering these types of devices. After a brief search, I found the GBA wrote to a rather odd location at <code class="highlight_hor_gray">0x8010420</code>. This was notably strange; normally any address from <code class="highlight_hor_gray">0x8000000</code> all the way to <code class="highlight_hor_gray">0xDFFFFFF</code> is supposed to map to the cartridge&#39;s ROM.</p>

				<p class="center_img"><img src="am3_04.png" alt="GBA Memmap" /></p>
				<p class="img_caption">A brief table of the GBA&#39;s memory map. Only 32MB of ROM can be accessed at once. ROM is mirrored twice and can be accessed at different speeds.</p>

				<p class="inner_text">This large block of memory addresses should typically be read-only. There are some notable exceptions however, namely cartridge-based GPIO (used for real-time clocks, Boktai&#39;s Solar Sensor, WarioWare&#39;s gyroscope, Drill Dozer rumble), EEPROM for game saves, and a host of I/O ports on the e-Reader. So, having the Advance Movie Adapter write to this particular address indicates that it does something important related to operating its special hardware. The 1KB of code wrote a value of <code class="highlight_hor_gray">0x09</code> to <code class="highlight_hor_gray">0x8010420</code>, and shortly thereafter it read that address again to check the value. It seemed to wait in a loop until <code>Bit 0</code> of <code class="highlight_hor_gray">0x8010420</code> was set to zero. I theorized that this was some kind of status register, where writing to it triggers an action from the adapter, and it flips Bit 0 &#34;ON&#34; or &#34;OFF&#34; depending on whether the action is finished or not. At that moment, however, I didn&#39;t know what action the adapter performed.</p>

				<p class="inner_text">Moving on, I saw the 1KB of code initialize various bits of the GBA, much like most commercial games do. My working hypothesus was that the code was bootstrapping the system before possibly loading more code to handle reading the SmartMedia card and running videos. At some point, I assumed, it would grab more instructions from somewhere else. Some of the code was copied to RAM, and once executed, the CPU read from 2 new addresses: <code class="highlight_hor_gray">0x8010400</code> and <code class="highlight_hor_gray">0x8010408</code>. Whatever values where at these addresses were later used as parameters (the source and the length, respectively) for copying additional data to RAM where it would later run as code. It appeared my guess had been correct all along, and the adapter pulled in new blocks of code.</p>

				<p class="inner_text">I named the source register <code class="highlight_hor_gray">AM_BLK_ADDR</code>, the length register <code class="highlight_hor_gray">AM_BLK_SIZE</code>, and the status register <code class="highlight_hor_gray">AM_BLK_STAT</code>. Having these labels helped organize things throughout this whole process, especially since I didn&#39;t know how many other registers I might encounter. It seemed like writing <code class="highlight_hor_gray">0x09</code> to the status register caused the adapter to load some more code at a specified location, like switching ROM banks on earlier DMG/GBC cartridges. I quickly wrote some NDS homebrew to start testing these registers. The default values of <code class="highlight_hor_gray">AM_BLK_ADDR</code> was <code class="highlight_hor_gray">0x8000000</code> and the default value of <code class="highlight_hor_gray">AM_BLK_SIZE</code> was <code class="highlight_hor_gray">0x400</code>, therefore this new code bank was 1KB in size and would be mapped to the start of cartridge ROM address space.</p>

				<p class="inner_text">My NDS homebrew program changed further to mimic the process of writing to the status register. At first, I didn&#39;t see anything happen; no new code was loaded. It was only on the second write to <code class="highlight_hor_gray">AM_BLK_STAT</code> that the data changed. There&#39;s a reason why this only worked on the second time, which I&#39;ll get to in a bit. At any rate, a fresh 1KB block of code was now loaded. I knew I was on the right path as I found some ASCII strings at the beginning mentioning an &#34;ActImagine Loader&#34;. ActImagine was a company partnered with AM3; specifically, they developed the audio/video codec, optimizing it so that standard GBA hardware could run it all on the CPU. Immediately afterward, I altered the homebrew program to continue writing <code class="highlight_hor_gray">0x09</code> to <code class="highlight_hor_gray">AM_BLK_STAT</code> 32 times and dumping each 1KB block.</p>

				<p class="inner_text">The exact length of the Advance Movie Adapter&#39;s internal firmware was unknown, so I decided to just choose a random number of blocks and see what the results were. Usually with hardware of this sort, if the CPU tries to read past a certain bank, either the data begins to repeat thanks to memory mirroring or garbage data is returned. In either case, it would be relatively easy to determine the exact size of the firmware by skimming over the dump in hex editor. If it were larger than 32KB, I would have to expand the dump size and try again. Fortunately, I saw the data was mirrored after 12KB. I cut down the dump to this size, and with that, the Advance Movie Adapter&#39;s firmware had been successfully dump for the first time.</p>

				<p class="center_img"><img src="am3_05.png" alt="AM3 firmware" /></p>
				<p class="img_caption">Behold the Advance Movie Adapter&#39;s firmware in all its hexadecimal glory!</p>

				<p class="inner_text">Evidently, when booting up the adapter, the first block of firmware is automatically loaded. Every time <code class="highlight_hor_gray">0x09</code> is written to the status register, a new 1KB block is loaded sequentially. It starts at the beginning though, so the first swap technically does nothing, which is the reason I had to write to <code class="highlight_hor_gray">AM_BLK_STAT</code> twice to get any feedback. The initial bootloading part of the firmware loaded the rest of firmware into RAM where it presumably stayed until the GBA powered off. It checked Bit 8 of <code class="highlight_hor_gray">AM_BLK_STAT</code> to see if it was &#34;ON&#34;, otherwise it kept trying to swap in new blocks and copy them. According to my NDS homebrew tests, Bit 8 essentially acted as an end-of-file (EOF) marker. Once all 12 blocks had been swapped, this bit in the status register went from &#34;OFF&#34; to &#34;ON&#34;. It&#39;s intriguing to see the size of firmware wasn&#39;t hardcoded. If AM3 ever planned on changing firmware in later revisions of the adapter they wouldn&#39;t have to change this portion of the codebase, so in that regard it&#39;s a smart move.</p>

				<p class="inner_text_large"><strong>SmartMedia Shenanigans</strong></p>

				<p class="inner_text">With the firmware in my possession, I started emulating bits of the adapter in GBE+. Even if only fragments of the hardware were supported, it was required to properly debug things moving forward. Rather than doing all the research at once, the process here was more like doing a small set of tests and emulating the results until something finally worked. The Advance Movie Adapter was simply too intricate for me to tackle in one sitting, so I broke it down into approachable chunks. Once GBE+ could load the firmware and swap data as needed, I let the firmware continue running. Eventually, it wrote the value <code class="highlight_hor_gray">0x0B</code> to <code class="highlight_hor_gray">AM_BLK_STAT</code>. It pinged the status register waiting for Bit 14 to get set &#34;ON&#34;, and afterward it wrote to a handful of new, unknown addresses.</p>

				<p class="inner_text">For the time being, I ignored those writes and let the firmware proceed. Much to my delight, I finally got some visual output from GBE+. It was everyone&#39;s favorite friend, the Blue Screen of Death! As it so happens, if the firmware has any fatal errors, it will draw a red, blue, or green screen depending on what went wrong, although it displays no text to help identify the problem. The source appeared to come from one section of the firmware where it checked a single 32-bit value. GBE+ gave the incorrect value, thus causing the blue screen. The correct value was simply a 4 letter ASCII string called &#34;ASIG&#34;. I had no idea what that meant, but there was a clue. Prior to that, the firmware wrote <code class="highlight_hor_gray">0x01</code> to the status register, then started reading from <code class="highlight_hor_gray">AM_BLK_ADDR</code>. This was very similar to how it loads all 12KB of firmware into RAM, but something was obviously different now.</p>

				<p class="inner_text">My first assumption was that it was trying to read from the SmartMedia card. The only problem here was that I didn&#39;t have any of that data on hand. The next step then was to dump my SmartMedia cards. For those that are unfamiliar with SmartMedia cards, they were popular in the late 1990s to early 2000s as memory for digital cameras. Their usage eventually fell as smaller cards with higher capacities arrived, chiefly SD cards. These days, it&#39;s hardly used anywhere. Some companies still make multi-card readers that work over USB, but luckily I had an old printer lying around the house that accepted SmartMedia cards. Rather than simply copy over all of the files present on my AM3 SmartMedia card, I decided to make a full disk image backup of Detective Conan Episode #1. If this was overkill, I could always mount the backup and take the individual files from there. There was nothing fancy about the process here, just simply using the <strong>dd</strong> command found on various Unix-like systems to make an exact copy of the target disk drive.</p>

				<p class="center_img"><img src="am3_06.png" alt="Dumping the SmartMedia card" /></p>
				<p class="img_caption">SmartMedia cards aren&#39;t common anymore. My old HP PSC 2355 multifunction printer (circa 2005) can still read them though.</p>

				<p class="inner_text">The SmartMedia card dump was approximately 32MB in size, which matched the capacity written on the card. Exploring the dump with a hex editor, I discovered it did indeed have that same 4 letter ASCII string &#34;ASIG&#34; present. As I suspected, the firmware had been commanding the Advance Movie Adapter to read data from the SmartMedia card. While that was good news, I was puzzled how the adapter knew exactly where to start reading SmartMedia data. The &#34;ASIG&#34; string was located at the offset <code class="highlight_hor_gray">0x1D3C400</code> (about 29MB into the file) and I hadn&#39;t seen the firmware write that address or anything like it anywhere. For the time being, I simply hardcoded that location in GBE+ so I could proceed with debugging.</p>

				<p class="inner_text">I managed to get another error screen, this time ominously bright red. The firmware was able to read parts of the file, but when it appeared to try and read something else, everything fell apart in terms of emulation. One issue was that some of those unknown registers I&#39;d found earlier were vital to reading SmartMedia card data. After poking around the firmware&#39;s code, I saw that the first register was some kind of file position pointer. For those familiar with C++-style file handling, it seemed to be the equivalent of <strong>seekg()</strong>, essentially changing what position to read from the SmartMedia card everytime a new block was loaded. It could move forwards or backwards by accepting a positive or negative number; I named it <code class="highlight_hor_gray">AM_SMC_OFFS</code>. The second register was used to set the size of the block during loading. Consequently, this was named <code class="highlight_hor_gray">AM_SMC_SIZE</code>. Despite understanding how these two registers worked, the firmware still failed after a certain point.</p>

				<p class="inner_text">Right before giving GBE+ a red screen, the firmware read 16-bytes from a large group of unknown registers, then it compared the results with some values it had spent a lot of time calculating. If these two sets of data did not match, the adapter would abort booting up. Using more NDS homebrew, I probed these registers, however, initially I got bogus results. Looking through GBE+&#39;s logs, I noticed that the firmware wrote the value <code class="highlight_hor_gray">0x03</code> to <code class="highlight_hor_gray">AM_BLK_STAT</code>, something it hadn&#39;t previously done during the boot process. Once that was replicated in the homebrew test, the results were identical what the firmware expected. These 16-bytes of data must have been the so-called 128-bit DES encryption key I&#39;d read about (Plot Twist: it wasn&#39;t, but more on that later). It seemed writing to the status register in this manner enabled the GBA to access the key. I didn&#39;t know what to do with the key at the time, so I simply let GBE+ load it from a file and return the key&#39;s individual bytes when appropiate.</p>

				<p class="inner_text">Based on my analysis so far, specific values written to <code class="highlight_hor_gray">AM_BLK_STAT</code> were essentially commands. <code class="highlight_hor_gray">0x09</code> loaded firmware blocks, <code class="highlight_hor_gray">0x0B</code> seemed to unlock a bunch of the adapter&#39;s I/O registers as it always came before writing them, <code class="highlight_hor_gray">0x01</code> loaded SmartMedia blocks, and now I knew <code class="highlight_hor_gray">0x03</code> revealed the DES key. In my logs, I found a fifth command as well <code class="highlight_hor_gray">0x05</code>. This last one was a bit confusing to figure out. It seemingly caused a random number to replace the first 4 bytes of the DES key. Examining the value more closely, however, showed that it was actually a variable representing the length of that &#34;ASIG&#34; portion of data in the SmartMedia card dump. This &#34;ASIG&#34; section was in fact a file on the card, therefore this previously unidentified command switched between reading the DES key and the current file size.</p>

				<p class="center_img"><img src="am3_07.png" alt="List of commands sent to the adapter" /></p>
				<p class="img_caption">A list of commands sent to the Advance Movie Adapter. Technically, they&#39;re psuedo-commands, as each bit of the byte has a specific meaning.</p>

				<p class="inner_text">Now things were starting to make a bit more sense. AM3&#39;s SmartMedia cards used a FAT-12 filesystem. Rather than read data as one giant block of memory, the Advance Movie Adapter abstracted the filesystem and provided the GBA with access to specific files. That explained why the &#34;ASIG&#34; file was located at some 29MB offset. The mechanism for switching between files is yet another hardware register sitting in the adapter&#39;s I/O region. I named this specific register <code class="highlight_hor_gray">AM_SMC_FILE</code>. Homebrew tests confirmed that changing its value changed the location the adapter starting reading blocks of data. GBE+ only needed to correctly access each file within the SmartMedia card dump, and then most of the adapter&#39;s functionality would be complete. However, to successfully do that, the emulator would need at least some knowledge of the underlying FAT filesystem in order to map out each file.</p>

				<p class="inner_text_large"><strong>Full-figured Filesystem</strong></p>

				<p class="inner_text">When working on other peripherals, I was often forced to become familiar various different technologies, formats, and protocols. Before trying to emulate lots of Game Boy hardware, I had virtually no experience whatsoever with stuff like infrared, serial communications, flash memory, EEPROM, or networking. One never really stops learning new information, and in order to emulate exotic devices, developers have to study areas they might not know a great deal about. Filesystems are one example for me. Prior to working on the Advance Movie Adapter, the only filesystem I&#39;d looked at was the barebones one used by the Turbo File to make saves. Without gaining some insights on how <a href="https://en.wikipedia.org/wiki/File_Allocation_Table#FAT12">FAT-12</a> operated though, the adapter would never function in GBE+.</p>

				<p class="inner_text">FAT filesystems have <a href="https://fileadmin.cs.lth.se/cs/Education/EDA385/HT09/student_doc/FinalReports/FAT12_overview.pdf">extensive documentation</a> available online, so a little help from Wikipedia and Google sorted everything out. To go over the situation again, GBE+ has a complete byte-for-byte copy of the SmartMedia card dumped to a large 32MB file. This dump contains all the data on the card, including the filesystem and individual files. GBE+ needs to know the precise locations of each file so it can return the correct bytes when emulating the adapter. To find the location of each file, GBE+ needs to understand how the FAT filesystem works just enough to do some basic navigation. Other details about the filesystem are irrelevant; the emulator just needs to know where AM3&#39;s files are and not much else. It would be easy if the filesystem simply had a list with exact offsets, but that&#39;s simply not how FAT does things.</p>

				<p class="inner_text">It should be noted that technically the user could dump each file individually and GBE+ could load them up one at a time. That&#39;s actually an optional solution I have planned to implement in the future, where the emulator is supplied with a list of files to use when the adapter needs them. It would be similar to how the Dolphin emulator can run games using the filesystem extracted from a GC/Wii disk. However, supporting the raw binary dump of the original media takes priority. Providing a single file is more straightforward for a user than asking them to make a list of a dozen files. Using a complete disk image is the simpler and &#34;purer&#34; route.</p>

				<p class="inner_text">At any rate, the first step is to read the <strong>Master Boot Record</strong> or MBR for short. This is just the first 512 bytes of data in the dump, and it describes how partitions are arranged on the storage medium. The MBR by itself doesn&#39;t lead to the SmartMedia card&#39;s files, but it does show where the <strong>Volume Boot Record</strong>, or VBR, lies. The VBR is also sometimes called the Volume ID, and it contains crucial information about sectors, clusters, file allocation tables, and root directory entries. It has 32-byte entries with various fields of information that can be used to calculate the logical addresses of the <strong>First File Allocation Table</strong>, the <strong>Root Directory</strong>, and the <strong>Data Region</strong>. The last one contains the actual data for the files, and it&#39;s what GBE+ needs to find. Unfortunately, the logical addresses of the others have to be calculated first.</p>

				<p class="inner_text">Ultimately, it&#39;s a bit like those infamously lengthy <a href="https://zelda.fandom.com/wiki/Trading_Quest">&#34;Trade Sequences&#34;</a> in certain video games. Start with the MBR to get to the VBR. Use the VBR to get to the First File Allocation Table. Use that to get to the Root Directory. Finally, the Root Directory shows where the Data Region is. Things still aren&#39;t even finished! The Data Region has a table that can be parsed to find individual files. AM3 SmartMedia cards don&#39;t have any fancy directory structures, so when reading the data region, GBE+ doesn&#39;t have to move through any folders. The Data Region has 32-byte entries called Directory Entry Structures. Here the filesystem stores data such as the filename (in 8.3 format), creation dates and timestamps, last modification dates and timestamps, file size, and most importantly the starting cluster. The starting cluster is then used to calculate yet another offset, which <strong>finally</strong> points to the actual file data.</p>

				<p class="center_img"><img src="am3_08.png" alt="Finding the data on FAT filesystems" width="800" height="215" /></p>
				<p class="img_caption">Finding the exact location of an individual file is a multistep process with FAT filesystems.</p>

				<p class="inner_text">The task for GBE+ is to grab a list of all the files present in the Directory Entry Structures and make note of their absolute offsets within the SmartMedia card dump. Each time the adapter&#39;s firmware changes the value of <code class="highlight_hor_gray">AM_SMC_FILE</code>, GBE+ will use that offset when reading blocks of SmartMedia card data. The order of the files as they appear in the Data Region&#39;s Directory Entry Structures is the number the firmware must use when trying to access a specific file. It counts from zero, so writing a value of <code class="highlight_hor_gray">0x05</code> to the register would pull data from the 6th file. And so with that, GBE+ had implemented support for the Advance Movie Adapter!</p>

				<p class="inner_text">Well, almost. The bootup sequence never completed, and I was treated to yet another colorful error screen. Eventually, after going over several logs multiple times, I found a potential problem. There was another register the firmware kept reading, but I couldn&#39;t understand what its purpose was. By all accounts, according to my homebrew tests, it seemed like some kind of shadow copy of the <code class="highlight_hor_gray">AM_SMC_SIZE</code> register. Everytime I read these two registers, their values were the same, so GBE+ treated them the same. Both seemed to return <code class="highlight_hor_gray">0x400</code>. I wondered if maybe this unknown register was supposed to keep track of the remaining file size. Disassembling parts and pieces of the firmware&#39;s code proved it did check to see if the value ever decreased.</p>

				<p class="inner_text">It seemed rather unintuitive to have a dedicated register like this. The firmware could already grab the current file size via <code class="highlight_hor_gray">AM_FILE_SIZE</code>, and it was more than capable of manually tracking how many bytes it had read from the file and how many were left. I&#39;d assumed that a standalone register for that task was redundant, but apparently that wasn&#39;t the case. When I manually altered the value of that register through GBE+&#39;s debugger at the right time, the firmware happily went about its business and bypassed the error screen. Newer homebrew tests confirmed how the register really worked, and so it was named <code class="highlight_hor_gray">AM_SMC_EOF</code>, as it represented the number of bytes until the End-of-File was reached. Normally it reads back the same value and <code class="highlight_hor_gray">AM_SMC_SIZE</code>, but if the remaining bytes left to read is less than that, it indicates this value instead. And with that, GBE+ was finally able to fully boot the Advance Movie Adapter&#39;s firmware!</p>

				<p class="center_img"><img class="img_border" src="am3_09.png" alt="First frame of AM3 emulation" /></p>
				<p class="img_caption">At long last, GBE+ was finally displaying something! But something wasn&#39;t quite right...</p>

				<p class="inner_text">Well, almost. The emulator really did get past all of the firmware&#39;s initial checks and routines. It also started drawing something that wasn&#39;t an error screen. The first frame of the AM3 startup animation began to play, as evidenced by the &#34;powered by actimagine&#34; text displayed at the bottom. Everything was frozen, however. It was as if the firmware was waiting on something before proceeding, but what? Broadly speaking, when dealing with non-standard hardware for video game systems like this adapter, the device will halt for a couple of things: user input, internal data, or an interrupt of some kind. User input didn&#39;t apply here, as the animation normally ran without any interaction from the user. Internal data was similarly irrelevant, as no new hardware registers were accessed. That left interrupts as the most likely culprit.</p>

				<p class="inner_text">Interrupts are used to signal to the CPU and software that the hardware has taken a certain action or reached a certain status, such as reaching the start of the VBlank period or when a memory transfer is complete. Such interrupts exist on the GBA, and one in particular is actually quite rare to see. It&#39;s called the Game Pak interrupt. Most games only account for this interrupt in the event the cartridge is removed from the system while still powered on. In case someone accidentally knocks the cartridge loose (or rips it out like a savage) there is some recourse the GBA can take and immediately execute code to lockdown everything. This is handy as it avoids running random code. The Game Pak interrupt, however, can be triggered by just about anything if a cartridge wants to. That is to say, if the cartridge needs to alert the software about something, anything really, it has the power to raise an interrupt and have the CPU start processing it, no cart-yanking necessary. This secondary use of the Game Pak interrupt is quite literally never, ever, <strong>ever</strong> used at all, for any reason, by any commercial software on the GBA. Almost.</p>

				<p class="center_img"><img src="am3_10.png" alt="GBA interrupt chart" width="450" height="350" /></p>
				<p class="img_caption">You see that interrupt listed all the way at the end? Nobody uses that. Nobody.</p>

				<p class="inner_text">The Advance Movie Adapter likes to be exceptional, breaking all rules and conventions. Its firmware expects to receive Game Pak interrupts not just once or twice, but pretty much constantly, multiple times per-second. By manually forcing these interrupts to occur in GBE+, the animation sequence started, and GBE+ could even start viewing the video. I could think of only one thing that would cause so many Game Pak interrupts so consistently. Every time the adapter read a 1KB block of data from the SmartMedia card, it must have caused the interrupt to occur. The data transfer probably wasn&#39;t instantaneous, thus the firmware needed to be alerted when the process finished. Handling audio and video in real-time is obviously time sensitive, so the firmware is always on the lookout for when to start moving things along. Further homebrew tests established that the SmartMedia card transfers did raise Game Pak interrupts. All that was left for GBE+ to do now was issue those interrupts.</p>

				<p class="inner_text">Unlike real hardware, GBE+ doesn&#39;t delay the transfers. Once it recieves the command to read SmartMedia card data, it&#39;s right there for the emulated CPU to read. Still, to mimic some of the delay, GBE+ sends the Game Pak interrupt at the start of HBlank if necessary. This isn&#39;t 100% accurate, but it&#39;s a good enough compromise to get AM3 videos running at the appropiate framerate. The only shortcoming in GBE+ is that the emulator&#39;s internal buffer for the GBA&#39;s sample-based channels sometimes overflows, which causes bits of sound to repeat. Normally this doesn&#39;t happen for many GBA games, but I guess the way I designed the audio-video sync emulation in GBE+ is not quite perfect for how the Advance Movie Adapter wants to play sounds. It&#39;s something to fix in the future, for sure. For the most part, however, the videos run quite well.</p>

				<p class="center_img"><video controls width="480" height="320"><source src="am3.webm" type="video/webm"></video></p>
				<p class="img_caption">Scaled up, the video quality is okay, but one a real GBA it&#39;s actually enjoyable. Audio (spoken dialog at least) is pretty clear.</p>

				<p class="inner_text_large"><strong>The password is &#34;password&#34;</strong></p>

				<p class="inner_text">When I first started poking around the Advance Movie Adapter, I thought its encryption scheme would be the hardest thing to crack. However, once I supplied the firmware with the 128-bit DES key, everything was fine. I figured at least the key would be obscured somehow, or maybe have some sort of difficult to replicate process by which the adapter grabs the key. All it did was send a command by writing to <code class="highlight_hor_gray">AM_BLK_STAT</code>, and then it just read 16 bytes. The firmware would later use this key on its own and happily play videos in GBE+. On the surface, there simply wasn&#39;t anything complicated going on.</p>

				<p class="inner_text">The encyrption used by the Advance Movie Adapter is actually rather minimal. Some SmartMedia cards have built-in copy-protection known simply as &#34;ID&#34;, that is to say, each card has a unique, one-of-a-kind 128-bit number permanently written to it. No two cards will have the same ID. Cards that support this feature have a symbol, and naturally all of AM3&#39;s card have it. Software can look at this to identify specific cards, or use it for encryption purposes. At first, I thought all of the files on the SmartMedia card were encrypted with the ID used as a key, but that was not the case. A colleague of mine had also made their own dumps of AM3 SmartMedia cards. They had multiple copies of a Detective Conan Episode #1, but only 1 file differed between them.</p>

				<p class="center_img"><img src="am3_11.png" alt="Smart Media ID" /></p>
				<p class="img_caption">SmartMedia cards marked with an &#34;ID&#34; logo have a unique 128-bit number used in copy-protection schemes.</p>

				<p class="inner_text">If every file were encrypted with a unique key, every file of every dump would have been different. Now it seemed that just an individual file was actually encrypted. Together, we confirmed that this was the <code class="highlight_hor_gray">00.AM3</code> file. It&#39;s a small file measuring at only 136 bytes. At the beginning is a 4-character ASCII string &#34;SMID&#34;, which I assumed stood for &#34;SmartMedia ID&#34;. The next 4 bytes is the length of the usable data within the file, so altogether only 128 bytes are relevant. The firmware goes through many, many operations prior to opening the <code class="highlight_hor_gray">00.AM3</code> file, but as far as I understood things, it used other pieces of a couple of files to start decrypting the those 128-bytes. Eventually, the firmware ends up with a 16-byte array of unencrypted data which should match the SmartMedia card&#39;s ID. If there is no match, the boot process aborts</p>

				<p class="inner_text">Initially, I had believed that the DES key itself was the SmartMedia card&#39;s ID used for all cryptographic functions. However, the ID merely acts as a final check. This is validated by the fact that the firmware internally calculates the same value after decryption no matter what ID GBE+ provides, even all zeroes. In that sense then, the <code class="highlight_hor_gray">00.AM3</code> file acts as a sort of &#34;lock&#34; against physical piracy. If a given user copies an AM3 SmartMedia card to a generic blank SmartMedia card, this generic card will fail to boot when running inside the Advance Movie Adapter. The firmware will decrypt the lock file, but the results from the lock file have to match the SmartMedia card&#39;s ID, which is unique.</p>

				<p class="inner_text">There are several benefits to doing partial encryption and verification. When mass producing AM3 SmartMedia cards that have the same videos on them, only this relatively tiny lock file needs to be unique; the rest of the data can remain the same. This avoids having to decrypt the entire SmartMedia card too when running on a GBA. AM3 also sold their own brand of blank SmartMedia cards that could be taken to kiosks to write new videos for consumers, and the software on those machines likely had to calculate and create the lock file themselves, so this miniscule size speeds up the overall process. A smaller file like that also means less chance of corruption.</p>

				<p class="inner_text">This copy protection scheme was probably only ever designed to handle casual piracy concerns, making sure random kids couldn&#39;t burn copies of Pokemon episodes for their friends. Against more digital means, it&#39;s very susceptible, almost laughably so. For GBE+ to properly emulate the Advance Movie Adapter, it needs 3 pieces of information: the firmware, and AM3 SmartMedia card dump, and the 16-byte ID. The ID is what unlocks the ability for the firmware to play videos. However, consider that the firmware, after having decrypted the <code class="highlight_hor_gray">00.AM3</code> file, has a copy of what it <strong>expects</strong> the ID to look like. If someone were to take a peek at the GBA&#39;s RAM or CPU while the firmware was running, they would know what ID the firmware is looking for. Supply that ID to the firmware, and it runs without any trouble.</p>

				<p class="inner_text">While ordinarily it would require an extremely convoluted amount of engineering to physically intercept this value, it&#39;s trivial to virtually dissect the GBA with an emulator&#39;s debugger. It didn&#39;t take long for me to pinpoint where in RAM the firmware stored a 16-byte array representing the ID it wanted. I believed it would have been possible for the GBE+ to grab this ID and use it if the user didn&#39;t want to provide their own ID. To prove that it worked, I dumped my second AM3 SmartMedia card (Detective Conan Episode #2) but neglected to dump the card&#39;s ID. GBE+ waited for the firmware to reach a certain point, copied the necessary RAM, and used that ID instead. It worked flawlessly. I won&#39;t judge AM3 too harshly for essentially leaving the password in plain sight because 1) it held up for years since we&#39;re just now able to freely make copies and 2) I didn&#39;t want them to make a copy protection scheme that was actually difficult to bypass.</p>

				<p class="center_img"><img src="am3_12.png" alt="lol security" /></p>
				<p class="img_caption">While this image is a joke, it&#39;s not far off from what the firmware does internally. That&#39;s the real SmartMedia ID from one of my cards by the way ;)</p>

				<p class="inner_text_large"><strong>A &#34;reel&#34; piece of history</strong></p>

				<p class="inner_text">So now the Advance Movie Adapter has been successfully emulated after nearly 19 years. The subject of this article technically has nothing to do with actually playing games. The most interaction users have with the adapter&#39;s firmware is via playback controls like starting, stopping, fast forwarding, and rewinding. Some multi-episode AM3 SmartMedia cards also give users the option of choosing which one to start. There&#39;s a whole lot of video, but not a whole lot of game. As previously mentioned though, products like the adapter played an important role in the gradual progression of mobile video during the early 2000s. The Advance Movie Adapter also predates the Game Boy Advance Video cartridges, making it the first officially licensed attempt at offering consumers video on the GBA. As such, despite not being a video game, the adapter is arguably a critical piece of the handheld&#39;s history.</p>

				<p class="inner_text">The adapter&#39;s firmware has been <a href="https://archive.org/details/am3_firmware">uploaded to the Internet Archive</a> for educational and archival purposes. I&#39;ve always wanted to be one of the first to dump stuff like a system&#39;s BIOS or similar data, so it feels good to contribute something substantial. Hopefully it helps people better understand how the audio and video encoding works, and maybe perhaps enlighten us on how it all compares to the Game Boy Advance Video cartridges. Personally, I think the AM3 videos hold up quite nicely in practice. It&#39;s actually rather fun watching anime despite the limitations present. The artifacts in AM3 videos are far less prominent than its American counterparts. Of course, it&#39;s not completely eliminated, but it&#39;s only really obvious with darker colors (particularly blacks, blues, and browns). Everything else is rather decent given the GBA&#39;s screen size. Audio (which most of the time for anime amounts to dialog) is as crisp as it needs to be and doesn&#39;t sound horribly garbled or compressed.</p>

				<p class="center_img"><img src="am3_12a.png" alt="Chad AM3 video quality" /></p>
				<p class="img_caption">AM3 video quality looks like what you&#39;d expect from scaling down video to 240x160.</p>

				<p class="center_img"><img src="am3_12b.png" alt="Filthy American video quality" /></p>
				<p class="img_caption">The GBA Video Cartridges on the other hand have a constant kind of moiré pattern. It seems to not use enough colors as well (see random bits of blue on Sonic&#39;s gloves) and numerous compression artifacts.</p>

				<p class="inner_text">This brings me to the subject of preserving the AM3 SmartMedia cards. Surprisingly, the Advance Movie Adapter itself is not needed. It only provides the firmware and GBE+ can grab the 16-byte SmartMedia ID by itself. The SmartMedia data can be retrieved through any reader. The main problem facing preservation is the exact format of SmartMedia card dumps. While the most direct method would be to make a full disk image of the card, this is a less than optimal solution. Keep in mind that the SmartMedia card has a <strong>live, writeable</strong> FAT-12 filesystem. Any and all changes to the filesystem would result in a totally different CRC32, MD5, or SHA256 hash, making verification troublesome. Even something as simple as updating a file&#39;s timestamp would do that. There&#39;s also the issue that an operating system might make these kinds of minor changes to the filesystem just by accessing the drive, making a &#34;clean&#34; dump impossible to obtain.</p>

				<p class="inner_text">In my opinion, the best way forward would be to preserve the files themselves along with their original timestamp data. The timestamps are interesting and worthwhile to examine because they generally accurately reflect when specific cards were publically released in Japan. However, this data doesn&#39;t require the whole filesystem. The individual files can similarly be pulled from the filesystem; afterwards they can be hashed one by one for a given AM3 SmartMedia card. There are only about a dozen files per card, so a database would have to only group together a small number of them under a single entry. The tricky part then is the &#34;lock&#34; file used as copy protection. Each and every card will have a different lock file, even if the card has the same anime episodes or movies. For a database focused on cataloging things for verification, this lock file is a bit of a nightmare. I&#39;d suggest ignoring it altogether, since everyone&#39;s hashes of that file will be different. Nothing is ever going to match.</p>

				<p class="inner_text">Ultimately, it&#39;s not my call to make, just suggestions from my perspective as an emulator developer. Hopefully, however, AM3 SmartMedia cards will finally get the attention they deserve. There are over <a href="https://shonumi.github.io/dandocs.html#ama_lst">40 known AM3 SmartMedia cards</a> out there that came with pre-written movies or shows. Another dozen blank gashapon cards were released for AM3&#39;s kiosks; some second-hand cards available on eBay or Mercari might have an unknown number of unique episodes only released on those machines. To the best of my knowledge, no one knows how many (if any) of these videos could exist. It&#39;s certainly a project that would benefit from a large community effort. If anyone is interested in helping out, I&#39;d advise checking out the <a href="https://shonumi.github.io/articles/am3_dumping_guide.html">AM3 SmartMedia card dumping guide</a> I wrote earlier this year.</p>

				<p class="center_img"><img src="am3_13.png" alt="DAT mockup" width="882" height="350" /></p>
				<p class="img_caption">A mockup for a potential system of cataloging and preserving AM3 SmartMedia cards.</p>

				<p class="inner_text_large"><strong>Director&#39;s Cut</strong></p>

				<p class="inner_text">That about concludes this adventure. Overall, the Advance Movie Adapter was quite a wild ride. Using an unknown dump format for the media itself, extracting the firmware, piecing together undocumented registers and their functions, facing off against encryption, traversing a real filesystem, and contending with a rarely used GBA interrupt: there was a lot more going on than I expected. Personally, I&#39;m still somewhat amazed I actually managed to get everything working in the end. There are quite a bit of so-called &#34;moving parts&#34; involved with emulating the Advance Movie Adapter, and all of them have to operate properly, otherwise the whole thing fails. Even so, we now have extensive documentation on the adapter and its SmartMedia cards, as well as working emulation.</p>

				<p class="inner_text">It&#39;s been 5 full years since I began this journey and wrote my first <strong>Edge of Emulation</strong> article. My fascination with Game Boy hardware has led me to all kinds of places in that time. If you had told me all of the crazy stuff I&#39;d be investigating, especially before I became an emudev, I would have found it quite hard to believe. I&#39;ve always felt that emulation should be as thorough and complete as possible no matter how obscure certain games or products might be, I just never figured I would ever play any role at all in making it possible.</p>

				<p class="inner_text">After all that&#39;s happened since 2017, I&#39;m glad to say that the vast majority of the officially licensed Game Boy hardware is currently emulated in some shape or form. Previously, at least when I first got interested in this field, there were over a dozen items in this category. Now there&#39;s only a handful left to conquer. It&#39;s thanks to the combined work of the emulation and game preservation scene that we&#39;ve made it this far. Make no mistake, however, our job isn&#39;t finished. Even when these other few devices are emulated, other systems with their own peripherals and accessories are still out there, waiting for someone to take a look at the mysteries hidden within their hardware. It&#39;s a seemingly eternal task.</p>

				<p class="inner_text">As a final note, I feel it&#39;s time to reveal a particular project that I&#39;ve been focusing on for the last year: my upcoming book. It&#39;s the product of hundreds of hours of research and writing, featuring a detailed look at every officially licensed bit of hardware that directly interacted with Game Boy software. Included within its pages, readers will find the history of each device, technical descriptions of how it works, their overall impact on the gaming industry, and how they relate to other features or ideas found in different consoles. The book contains hundreds of photos and illustrations of the hardware itself and shows hundreds of screenshots from the software in action. There&#39;ll even be a bonus section exploring several unreleased add-ons, including never-before-seen photos of the NetCard.</p>

				<p class="center_img"><img src="am3_14.png" alt="My book" width="435" height="350" /></p>
				<p class="img_caption">It&#39;s been a dream of mine to become a published author for some time. Now it&#39;s really happening!</p>

				<p class="inner_text">The first draft is complete, and work is being done on a more polished second draft. It will be done soon-ish, hopefully. Unfortunately, it consumes a lot of my time these days, leaving me unable to respond to emails, Reddit, and Discord promptly. Still, the hardest parts are done (I think), and I&#39;m very exciting to finally start launching my writing career. Keep in mind, this book wouldn&#39;t have been possible without emulation. As important as it is to preserve video games, we also need to observe, review, comment upon, and contextualize them in order to fully understand and appreciate the history behind them.</p>

				<p class="center_img">As always, remember: <em>Never give up. Never surrender. Emulate everything!</em></p>
				<p class="img_caption"></p>

			</div>
		</div>

		<p> </p> 

	</body>
</html>




